"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Mongo = void 0;
const mongodb_1 = require("mongodb");
const defaults_1 = require("./defaults");
function Mongo(opts) {
    var _a;
    let client;
    let connection;
    if ("client" in opts)
        client = opts.client;
    else {
        client = new mongodb_1.MongoClient(opts.url, opts.config);
        connection = client.connect();
        connection.catch(opts.onInitError);
    }
    const collection = client.db(opts.database).collection((_a = opts.collection) !== null && _a !== void 0 ? _a : defaults_1.defaults.table);
    return {
        async get(key) {
            var _a;
            // since we synchronously return store instance
            await connection;
            return (_a = (await collection.findOne({ key }))) === null || _a === void 0 ? void 0 : _a.session;
        },
        async set(key, session) {
            await connection;
            await collection.updateOne({ key }, { $set: { key, session } }, { upsert: true });
        },
        async delete(key) {
            await connection;
            await collection.deleteOne({ key });
        },
    };
}
exports.Mongo = Mongo;
